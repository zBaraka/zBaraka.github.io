<html lang="en">
<head>
  <base href="https://www.skybrute.de">
  <link rel="icon" href="https://i.imgur.com/JP4qYpv.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skybrute</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #6200ea;
      --secondary-color: #03dac6;
      --background-color: #121212;
      --card-background: #1f1f1f;
      --text-color: #ffffff;
      --accent-color: #bb86fc;
      --now-playing-height: 80px;
      --card-hover-scale: 1.05;
      --shadow-color: rgba(0, 0, 0, 0.5);
      --play-button-color: #ffffff;
      --progress-bar-color: #444;
      --progress-handle-color: #777;
      --shuffle-active-color: var(--accent-color);
      --loop-active-color: #ff4081;
      --visualizer-active-color: #00ff00;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    body {
      background: var(--background-color);
      color: var(--text-color);
      min-height: 100vh;
      padding: 2rem;
      padding-bottom: calc(2rem + var(--now-playing-height));
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      margin-bottom: 4rem;
      position: relative;
      z-index: 2;
    }
    .logo {
      position: fixed;
      top: 1rem;
      left: 1rem;
      width: 150px;
      height: auto;
      z-index: 100;
    }
    .logo img {
      width: 100%;
      height: auto;
      display: block;
      filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.5));
      transition: transform 0.3s ease;
    }
    .logo img:hover {
      transform: scale(1.05);
    }
    .navigation {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 100;
      display: flex;
      gap: 1rem;
    }
    .search-container {
      margin: 4rem auto 1rem;
      max-width: 600px;
      padding: 0 1rem;
      animation: fadeIn 1s ease-in-out;
    }
    .search-input {
      width: 100%;
      padding: 1rem 1.2rem;
      font-size: 1rem;
      background: var(--card-background);
      border: none;
      border-radius: 12px;
      color: var(--text-color);
      box-shadow: 0 2px 5px var(--shadow-color);
    }
    .search-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--primary-color);
    }
    .music-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 2rem;
      padding: 2rem 1rem;
      animation: fadeInUp 1s ease-in-out;
    }
    .music-card {
      background: var(--card-background);
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      box-shadow: 0 5px 15px var(--shadow-color);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }
    .music-card:hover {
      transform: scale(var(--card-hover-scale));
      box-shadow: 0 10px 25px var(--shadow-color);
    }
    .music-card .thumbnail {
      width: 100%;
      aspect-ratio: 1 / 1;
      background: #2a2a2a;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .music-card .thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    .music-card:hover .thumbnail img {
      transform: scale(1.1);
    }
    .play-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      background: linear-gradient(45deg, rgba(0,0,0,0.6), rgba(0,0,0,0.4));
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }
    .music-card:hover .play-overlay {
      opacity: 1;
    }
    .play-icon {
      font-size: 3rem;
      color: white;
      text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
      transition: transform 0.2s ease-in-out;
    }
    .play-overlay:hover .play-icon {
      transform: scale(1.1);
    }
    .song-info {
      padding: 1.2rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .song-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .audio-control {
      display: none;
    }
    #now-playing {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-background);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      box-shadow: 0 -5px 20px var(--shadow-color);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      height: var(--now-playing-height);
      backdrop-filter: blur(15px);
      z-index: 100;
    }
    .now-playing-info {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex: 1 1 auto;
      min-width: 150px;
      max-width: 400px;
      overflow: hidden;
      animation: slideUp 0.5s ease-in-out;
    }
    .now-playing-thumbnail {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 3px 10px var(--shadow-color);
      transition: transform 0.2s ease-in-out;
      background-color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .now-playing-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .now-playing-thumbnail:hover {
      transform: scale(1.05);
    }
    .now-playing-title {
      font-size: 1.1rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .playback-controls {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex: 0 0 auto;
    }
    .control-button {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-size: 1.3rem;
      padding: 0.7rem;
      border-radius: 50%;
      transition: color 0.2s ease-in-out, transform 0.2s ease-in-out, background-color 0.2s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .control-button:hover {
      color: var(--primary-color);
      background-color: rgba(255, 255, 255, 0.1);
    }
    .control-button.active {
      color: var(--secondary-color);
    }
    .control-circle {
      background: var(--card-background);
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0.7rem;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px var(--shadow-color);
      transition: all 0.3s ease;
    }
    .control-circle:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow-color);
    }
    .shuffle-button.active {
      color: var(--shuffle-active-color);
      box-shadow: 0 0 0 2px var(--shuffle-active-color);
    }
    .loop-button.active {
      color: var(--loop-active-color);
      box-shadow: 0 0 0 2px var(--loop-active-color);
    }
    #autoplay-toggle.active {
      color: var(--secondary-color);
      box-shadow: 0 0 0 2px var(--secondary-color);
    }
    #visualizer-toggle.active {
      color: var(--visualizer-active-color);
      box-shadow: 0 0 0 2px var(--visualizer-active-color);
    }
    .progress-container {
      flex: 2 1 300px;
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 0 1.5rem;
      width: 100%;
      animation: zoomIn 0.5s ease-in-out;
    }
    .progress-bar {
      flex: 1;
      height: 8px;
      background: var(--progress-bar-color);
      border-radius: 4px;
      position: relative;
      cursor: pointer;
      overflow: hidden;
    }
    .progress-filled {
      height: 100%;
      background: var(--primary-color);
      width: 0%;
      transition: width 0.1s linear;
    }
    .progress-handle {
      position: absolute;
      top: 50%;
      left: 0%;
      width: 16px;
      height: 16px;
      background: var(--progress-handle-color);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: grab;
      transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
    }
    .progress-handle:active {
      cursor: grabbing;
      transform: translate(-50%, -50%) scale(1.2);
      background-color: white;
    }
    .volume-control {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 0 1.5rem;
      flex: 0 0 auto;
    }
    .volume-slider {
      width: 100px;
      height: 6px;
      -webkit-appearance: none;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
      outline: none;
    }
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    .volume-slider::-webkit-slider-thumb:hover {
      background-color: white;
    }
    .time-display {
      font-size: 0.9rem;
      color: var(--text-color);
      min-width: 110px;
      text-align: center;
    }
    .no-results {
      text-align: center;
      padding: 3rem;
      color: #888;
      grid-column: 1 / -1;
      font-size: 1.2rem;
    }
    .visualizer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      opacity: 0.4;
      background: transparent;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes zoomIn {
      from {
        transform: scale(0.9);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    /* Media queries for responsiveness */
    @media (max-width: 768px) {
      .music-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1.5rem;
      }
      .song-title {
        font-size: 0.95rem;
      }
      .control-button {
        font-size: 1.1rem;
      }
      #now-playing {
        padding: 0.8rem 1rem;
      }
      .time-display {
        display: none;
      }
      .logo {
        width: 100px;
      }
      .volume-control {
        display: none;
      }
      .navigation {
        top: 0.7rem;
        right: 0.7rem;
        gap: 0.5rem;
      }
      .control-circle {
        width: 35px;
        height: 35px;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Visualizer Canvas (background) -->
  <canvas id="visualizer" class="visualizer"></canvas>

  <div class="logo">
    <img src="https://i.imgur.com/xCFfLev.png" alt="SkyBrute Logo" id="logo-image">
  </div>
  
  <div class="navigation">
    <button class="control-circle shuffle-button" id="shuffle-button" aria-label="Shuffle">
      <i class="fas fa-random"></i>
    </button>
    <button class="control-circle loop-button" id="loop-button" aria-label="Loop Track">
      <i class="fas fa-redo"></i>
    </button>
    <button class="control-circle" id="autoplay-toggle" aria-label="Toggle Autoplay">
      <i class="fas fa-infinity"></i>
    </button>
    <button class="control-circle" id="visualizer-toggle" aria-label="Toggle Visualizer">
      <i class="fas fa-chart-bar"></i>
    </button>
  </div>
  
  <!-- Mobile Version Link removed -->

  <div class="container">
    <div class="search-container">
      <input type="text" class="search-input" placeholder="Search songs..." id="search-input" aria-label="Search songs">
    </div>
    <div class="music-grid" id="music-grid">
      <!-- Music cards will be dynamically inserted here -->
    </div>
  </div>
  
  <div id="now-playing">
    <div class="now-playing-info">
      <div class="now-playing-thumbnail" id="now-playing-thumbnail">
        <i class="fas fa-music" style="font-size: 1.5rem; opacity: 0.7;"></i>
      </div>
      <span class="now-playing-title" id="current-song">Nothing playing</span>
    </div>
    
    <div class="playback-controls">
      <button class="control-button" id="prev-track" aria-label="Previous Track">
        <i class="fas fa-step-backward"></i>
      </button>
      <button class="control-button" id="play-pause-control" aria-label="Play/Pause">
        <i class="fas fa-play" id="play-pause-icon"></i>
      </button>
      <button class="control-button" id="next-track" aria-label="Next Track">
        <i class="fas fa-step-forward"></i>
      </button>
    </div>
    
    <div class="progress-container">
      <div class="progress-bar" id="progress-bar" aria-label="Progress Bar">
        <div class="progress-filled" id="progress-filled"></div>
        <div class="progress-handle" id="progress-handle"></div>
      </div>
      <div class="time-display" id="time-display">0:00 / 0:00</div>
    </div>
    
    <div class="volume-control">
      <button class="control-button" id="volume-button" aria-label="Toggle Volume">
        <i class="fas fa-volume-up"></i>
      </button>
      <input type="range" class="volume-slider" id="volume-slider" min="0" max="1" step="0.01" value="1" aria-label="Volume Slider">
    </div>
  </div>

  <script>
    // Global variables for music player
    const musicGrid = document.getElementById('music-grid');
    const nowPlaying = document.getElementById('now-playing');
    const progressFilled = document.getElementById('progress-filled');
    const progressBar = document.getElementById('progress-bar');
    const progressHandle = document.getElementById('progress-handle');
    const currentSongDisplay = document.getElementById('current-song');
    const playPauseControl = document.getElementById('play-pause-control');
    const playPauseIcon = document.getElementById('play-pause-icon');
    const prevTrackButton = document.getElementById('prev-track');
    const nextTrackButton = document.getElementById('next-track');
    const shuffleButton = document.getElementById('shuffle-button');
    const volumeSlider = document.getElementById('volume-slider');
    const volumeButton = document.getElementById('volume-button');
    const autoplayToggle = document.getElementById('autoplay-toggle');
    const loopButton = document.getElementById('loop-button');
    const timeDisplay = document.getElementById('time-display');
    const searchInput = document.getElementById('search-input');
    const visualizerToggle = document.getElementById('visualizer-toggle');
    const canvas = document.getElementById('visualizer');
    const canvasCtx = canvas.getContext('2d');
    
    let allMusicCards = [];
    let currentAudio = null;
    let lastVolume = 1;
    let currentTrackIndex = 0;
    let tracks = [];
    let playbackModes = {
      current: 'none',
      lastKnownIndex: -1,
      shuffledOrder: []
    };
    let isDragging = false;

    // Variables for Visualizer
    let visualizerActive = false;
    let audioCtx = null;
    let analyser = null;
    let visualizerAnimationId = null;
    let visualizerSource = null;

    // Resize canvas to fill viewport
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
    
    function updateTimeDisplay(audio) {
      if (audio && !isNaN(audio.duration)) {
        timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
      } else {
        timeDisplay.textContent = '0:00 / 0:00';
      }
    }
    
    function updateNowPlayingInfo(title, thumbnailSrc) {
      currentSongDisplay.textContent = title;
      const thumbnailContainer = document.getElementById('now-playing-thumbnail');
      
      if (thumbnailSrc) {
        thumbnailContainer.innerHTML = `<img src="${thumbnailSrc}" alt="${title}">`;
      } else {
        thumbnailContainer.innerHTML = `<i class="fas fa-music" style="font-size: 1.5rem; opacity: 0.7;"></i>`;
      }
      
      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: title,
          artist: 'Skybrute',
          artwork: thumbnailSrc ? [{ src: thumbnailSrc }] : []
        });
      }
      
      // Update document title
      document.title = "Skybrute - " + title;
    }
    
    function createMusicCard(song, index) {
      const card = document.createElement('div');
      card.className = 'music-card';
      
      const thumbnailHTML = song.thumbnail 
        ? `<div class="thumbnail">
            <img src="${song.thumbnail}" alt="${song.title}">
            <div class="play-overlay">
              <i class="fas fa-play play-icon"></i>
            </div>
          </div>` 
        : `<div class="thumbnail">
            <i class="fas fa-music" style="font-size: 3rem; opacity: 0.5;"></i>
            <div class="play-overlay">
              <i class="fas fa-play play-icon"></i>
            </div>
          </div>`;
      
      card.innerHTML = `
        ${thumbnailHTML}
        <div class="song-info">
          <div class="song-title">${song.title}</div>
          <audio class="audio-control" crossorigin="anonymous" src="${song.path}" preload="auto"></audio>
        </div>
      `;
      
      const audio = card.querySelector('audio');
      const playOverlay = card.querySelector('.play-overlay');
      const playIcon = card.querySelector('.play-icon');
      
      audio.preload = "auto";
      
      playOverlay.addEventListener('click', () => {
        if (currentAudio && currentAudio !== audio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          updatePlayIcon(currentAudio.closest('.music-card'), false);
        }
        
        const isPlaying = !audio.paused;
        
        if (isPlaying) {
          audio.pause();
          playPauseIcon.classList.remove('fa-pause');
          playPauseIcon.classList.add('fa-play');
        } else {
          audio.play().catch(e => console.error('Playback failed:', e));
          playPauseIcon.classList.remove('fa-play');
          playPauseIcon.classList.add('fa-pause');
        }
        
        currentAudio = audio;
        currentTrackIndex = index;
        nowPlaying.style.display = 'flex';
        updateNowPlayingInfo(song.title, song.thumbnail);
        updatePlayIcon(card, !isPlaying);
        currentAudio.volume = parseFloat(volumeSlider.value);
        
        if (visualizerActive && audioCtx) {
          if (audioCtx.state === 'suspended') audioCtx.resume();
          connectVisualizer(currentAudio);
        }
      });
      
      audio.addEventListener('ended', () => {
        const wasPlayingCard = audio.closest('.music-card');
        updatePlayIcon(wasPlayingCard, false);
        
        if (playbackModes.current === 'loop') {
          audio.currentTime = 0;
          audio.play();
        } else if (playbackModes.current !== 'none') {
          playNextTrack();
        } else {
          playPauseIcon.classList.remove('fa-pause');
          playPauseIcon.classList.add('fa-play');
        }
      });
      
      audio.addEventListener('timeupdate', () => {
        if (!isDragging && !isNaN(audio.duration)) {
          const progressPercent = audio.currentTime / audio.duration * 100;
          progressFilled.style.width = `${progressPercent}%`;
          progressHandle.style.left = `${progressPercent}%`;
          updateTimeDisplay(audio);
        }
      });
      
      return card;
    }
    
    function updatePlayIcon(card, isPlaying) {
      if (!card) return;
      
      const playIcon = card.querySelector('.play-icon');
      
      if (isPlaying) {
        playIcon.classList.remove('fa-play');
        playIcon.classList.add('fa-pause');
      } else {
        playIcon.classList.remove('fa-pause');
        playIcon.classList.add('fa-play');
      }
    }
    
    function updateAllPlayIcons(exceptCard = null) {
      allMusicCards.forEach(card => {
        if (card !== exceptCard) {
          updatePlayIcon(card, false);
        }
      });
    }
    
    searchInput.addEventListener('input', e => {
      filterSongs(e.target.value);
    });
    
    function filterSongs(searchTerm) {
      const normalizedSearch = searchTerm.toLowerCase();
      let hasResults = false;
      
      allMusicCards.forEach((card, index) => {
        const songTitle = card.querySelector('.song-title').textContent.toLowerCase();
        
        if (songTitle.includes(normalizedSearch)) {
          card.style.display = 'flex';
          hasResults = true;
        } else {
          card.style.display = 'none';
        }
      });
      
      const existingNoResults = musicGrid.querySelector('.no-results');
      if (existingNoResults) {
        existingNoResults.remove();
      }
      
      if (!hasResults && searchTerm) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = 'No songs found matching your search';
        musicGrid.appendChild(noResults);
      }
    }
    
    function getNextTrackIndex() {
      if (playbackModes.current === 'shuffle') {
        if (playbackModes.shuffledOrder.length === 0 || currentTrackIndex === -1) {
          playbackModes.shuffledOrder = [...Array(tracks.length).keys()];
          for (let i = playbackModes.shuffledOrder.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [playbackModes.shuffledOrder[i], playbackModes.shuffledOrder[j]] = 
              [playbackModes.shuffledOrder[j], playbackModes.shuffledOrder[i]];
          }
          playbackModes.lastKnownIndex = 0;
          return playbackModes.shuffledOrder[0];
        }
        
        playbackModes.lastKnownIndex++;
        if (playbackModes.lastKnownIndex >= playbackModes.shuffledOrder.length) {
          playbackModes.lastKnownIndex = 0;
        }
        return playbackModes.shuffledOrder[playbackModes.lastKnownIndex];
      }
      
      return (currentTrackIndex + 1) % tracks.length;
    }
    
    function updateModeIndicators() {
      shuffleButton.classList.toggle('active', playbackModes.current === 'shuffle');
      autoplayToggle.classList.toggle('active', playbackModes.current === 'autoplay');
      loopButton.classList.toggle('active', playbackModes.current === 'loop');
    }
    
    function playNextTrack() {
      updateAllPlayIcons();
      
      if (tracks.length === 0) return;
      
      const newIndex = playbackModes.current === 'none' ? 
        (currentTrackIndex + 1) % tracks.length : getNextTrackIndex();
        
      if (newIndex === currentTrackIndex) return;
      
      currentTrackIndex = newIndex;
      const nextCard = allMusicCards[currentTrackIndex];
      
      if (currentAudio) {
        const previousCard = currentAudio.closest('.music-card');
        currentAudio.pause();
        currentAudio.currentTime = 0;
        updatePlayIcon(previousCard, false);
      }
      
      if (nextCard) {
        const audio = nextCard.querySelector('audio');
        audio.volume = parseFloat(volumeSlider.value);
        audio.play().catch(console.error);
        currentAudio = audio;
        updateNowPlayingInfo(tracks[currentTrackIndex].title, tracks[currentTrackIndex].thumbnail);
        playPauseIcon.classList.remove('fa-play');
        playPauseIcon.classList.add('fa-pause');
        updatePlayIcon(nextCard, true);
        
        if (visualizerActive && audioCtx) {
          if (audioCtx.state === 'suspended') audioCtx.resume();
          connectVisualizer(currentAudio);
        }
      }
    }
    
    function playPrevTrack() {
      updateAllPlayIcons();
      
      if (tracks.length === 0) return;
      
      if (currentAudio && currentAudio.currentTime > 3) {
        // If track has played for more than 3 seconds, restart it instead of going to previous
        currentAudio.currentTime = 0;
        return;
      }
      
      if (currentAudio) {
        const previousCard = currentAudio.closest('.music-card');
        currentAudio.pause();
        currentAudio.currentTime = 0;
        updatePlayIcon(previousCard, false);
      }
      
      currentTrackIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length;
      const prevCard = allMusicCards[currentTrackIndex];
      
      if (prevCard) {
        const audio = prevCard.querySelector('audio');
        audio.volume = parseFloat(volumeSlider.value);
        audio.play().catch(console.error);
        currentAudio = audio;
        updateNowPlayingInfo(tracks[currentTrackIndex].title, tracks[currentTrackIndex].thumbnail);
        playPauseIcon.classList.remove('fa-play');
        playPauseIcon.classList.add('fa-pause');
        updatePlayIcon(prevCard, true);
        
        if (visualizerActive && audioCtx) {
          if (audioCtx.state === 'suspended') audioCtx.resume();
          connectVisualizer(currentAudio);
        }
      }
    }
    
    playPauseControl.addEventListener('click', () => {
      if (currentAudio) {
        if (currentAudio.paused) {
          currentAudio.play().catch(e => console.error('Playback failed:', e));          playPauseIcon.classList.remove('fa-play');
          playPauseIcon.classList.add('fa-pause');
          updatePlayIcon(currentAudio.closest('.music-card'), true);
        } else {
          currentAudio.pause();
          playPauseIcon.classList.remove('fa-pause');
          playPauseIcon.classList.add('fa-play');
          updatePlayIcon(currentAudio.closest('.music-card'), false);
        }
      } else if (tracks.length > 0) {
        // If nothing is playing but tracks exist, play the first one
        const firstCard = allMusicCards[0];
        if (firstCard) {
          firstCard.querySelector('.play-overlay').click();
        }
      }
    });
    
    nextTrackButton.addEventListener('click', playNextTrack);
    prevTrackButton.addEventListener('click', playPrevTrack);
    
    shuffleButton.addEventListener('click', () => {
      const wasActive = playbackModes.current === 'shuffle';
      playbackModes.current = wasActive ? 'none' : 'shuffle';
      
      if (!wasActive && playbackModes.current === 'shuffle') {
        // When enabling shuffle, disable other modes
        autoplayToggle.classList.remove('active');
        loopButton.classList.remove('active');
      }
      
      localStorage.setItem('playbackMode', playbackModes.current);
      updateModeIndicators();
    });
    
    loopButton.addEventListener('click', () => {
      const wasActive = playbackModes.current === 'loop';
      playbackModes.current = wasActive ? 'none' : 'loop';
      
      if (!wasActive && playbackModes.current === 'loop') {
        // When enabling loop, disable other modes
        autoplayToggle.classList.remove('active');
        shuffleButton.classList.remove('active');
      }
      
      localStorage.setItem('playbackMode', playbackModes.current);
      updateModeIndicators();
    });
    
    autoplayToggle.addEventListener('click', () => {
      const wasActive = playbackModes.current === 'autoplay';
      playbackModes.current = wasActive ? 'none' : 'autoplay';
      
      if (!wasActive && playbackModes.current === 'autoplay') {
        // When enabling autoplay, disable other modes
        shuffleButton.classList.remove('active');
        loopButton.classList.remove('active');
      }
      
      localStorage.setItem('playbackMode', playbackModes.current);
      updateModeIndicators();
    });
    
    // Progress bar interactions
    progressBar.addEventListener('click', e => {
      if (currentAudio) {
        const rect = progressBar.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        currentAudio.currentTime = pos * currentAudio.duration;
      }
    });
    
    progressHandle.addEventListener('mousedown', e => {
      isDragging = true;
      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', stopDrag);
      e.preventDefault(); // Prevent text selection
    });
    
    progressHandle.addEventListener('touchstart', e => {
      isDragging = true;
      document.addEventListener('touchmove', onDragTouch);
      document.addEventListener('touchend', stopDrag);
      e.preventDefault(); // Prevent scrolling
    });
    
    function onDrag(e) {
      if (currentAudio && isDragging) {
        const rect = progressBar.getBoundingClientRect();
        let pos = (e.clientX - rect.left) / rect.width;
        pos = Math.max(0, Math.min(1, pos));
        progressFilled.style.width = `${pos * 100}%`;
        progressHandle.style.left = `${pos * 100}%`;
        currentAudio.currentTime = pos * currentAudio.duration;
      }
    }
    
    function onDragTouch(e) {
      if (currentAudio && isDragging) {
        const touch = e.touches[0];
        const rect = progressBar.getBoundingClientRect();
        let pos = (touch.clientX - rect.left) / rect.width;
        pos = Math.max(0, Math.min(1, pos));
        progressFilled.style.width = `${pos * 100}%`;
        progressHandle.style.left = `${pos * 100}%`;
        currentAudio.currentTime = pos * currentAudio.duration;
      }
    }
    
    function stopDrag() {
      isDragging = false;
      document.removeEventListener('mousemove', onDrag);
      document.removeEventListener('mouseup', stopDrag);
      document.removeEventListener('touchmove', onDragTouch);
      document.removeEventListener('touchend', stopDrag);
    }
    
    // Keyboard shortcuts
    function handleKeyboardShortcuts(e) {
      const tag = e.target.tagName.toLowerCase();
      if (tag === 'input' || tag === 'textarea') return;
      
      switch (e.key) {
        case ' ':
          e.preventDefault();
          playPauseControl.click();
          break;
        case 'ArrowRight':
          if (currentAudio) {
            currentAudio.currentTime = Math.min(currentAudio.duration, currentAudio.currentTime + 10);
          }
          break;
        case 'ArrowLeft':
          if (currentAudio) {
            currentAudio.currentTime = Math.max(0, currentAudio.currentTime - 10);
          }
          break;
        case 'ArrowUp':
          e.preventDefault();
          volumeSlider.value = Math.min(parseFloat(volumeSlider.value) + 0.1, 1).toFixed(1);
          volumeSlider.dispatchEvent(new Event('input'));
          break;
        case 'ArrowDown':
          e.preventDefault();
          volumeSlider.value = Math.max(parseFloat(volumeSlider.value) - 0.1, 0).toFixed(1);
          volumeSlider.dispatchEvent(new Event('input'));
          break;
        case 'm':
        case 'M':
          volumeButton.click();
          break;
        case 'n':
        case 'N':
          nextTrackButton.click();
          break;
        case 'p':
        case 'P':
          prevTrackButton.click();
          break;
        case 's':
        case 'S':
          shuffleButton.click();
          break;
        case 'l':
        case 'L':
          loopButton.click();
          break;
        // Number keys to jump to percentage of track
        case '0': case '1': case '2': case '3': case '4':
        case '5': case '6': case '7': case '8': case '9':
          if (currentAudio && currentAudio.duration) {
            const percentage = parseInt(e.key) * 10 / 100;
            currentAudio.currentTime = currentAudio.duration * percentage;
          }
          break;
      }
    }
    
    document.addEventListener('keydown', handleKeyboardShortcuts);
    
    // Volume control
    function updateVolumeIcon(volume) {
      const volumeIcon = volumeButton.querySelector('i');
      
      if (volume > 0.5) {
        volumeIcon.className = 'fas fa-volume-up';
      } else if (volume > 0) {
        volumeIcon.className = 'fas fa-volume-down';
      } else {
        volumeIcon.className = 'fas fa-volume-mute';
      }
    }
    
    function initializeVolume() {
      const savedVolume = localStorage.getItem('volume');
      if (savedVolume !== null) {
        volumeSlider.value = savedVolume;
        if (currentAudio) {
          currentAudio.volume = parseFloat(savedVolume);
        }
        updateVolumeIcon(savedVolume);
      }
    }
    
    volumeSlider.addEventListener('input', e => {
      if (currentAudio) {
        currentAudio.volume = e.target.value;
      }
      localStorage.setItem('volume', e.target.value);
      lastVolume = e.target.value > 0 ? e.target.value : 0.5; // Remember non-zero volume
      updateVolumeIcon(e.target.value);
    });
    
    volumeButton.addEventListener('click', () => {
      if (currentAudio) {
        if (currentAudio.volume > 0) {
          // Store current volume before muting
          lastVolume = currentAudio.volume > 0 ? currentAudio.volume : 0.5;
          currentAudio.volume = 0;
          volumeSlider.value = 0;
        } else {
          currentAudio.volume = lastVolume;
          volumeSlider.value = lastVolume;
        }
        updateVolumeIcon(currentAudio.volume);
      }
      localStorage.setItem('volume', currentAudio ? currentAudio.volume : lastVolume);
    });
    
    // Visualizer functions
    function setupVisualizer() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (!analyser) {
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256; // For better performance
      }
    }
    
    function connectVisualizer(audioElement) {
      try {
        // Disconnect current visualizer source if exists
        if (visualizerSource) {
          try { visualizerSource.disconnect(); } catch(e){}
        }
        
        // Check if this element already has a source node
        if (!audioElement.__mediaElementSource) {
          audioElement.__mediaElementSource = audioCtx.createMediaElementSource(audioElement);
        }
        
        visualizerSource = audioElement.__mediaElementSource;
        visualizerSource.connect(analyser);
        analyser.connect(audioCtx.destination);
      } catch (e) {
        console.error('Visualizer connection error:', e);
      }
    }
    
    function drawVisualizer() {
      if (!visualizerActive) return;
      
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      
      analyser.getByteFrequencyData(dataArray);
      canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Improved visualizer with gradient colors
      const barWidth = (canvas.width / bufferLength) * 2.5;
      let barHeight;
      let x = 0;
      
      // Create gradient
      const gradient = canvasCtx.createLinearGradient(0, canvas.height, 0, 0);
      gradient.addColorStop(0, '#6200ea');
      gradient.addColorStop(0.5, '#bb86fc');
      gradient.addColorStop(1, '#03dac6');
      
      for (let i = 0; i < bufferLength; i++) {
        barHeight = dataArray[i] * 1.5; // Amplify for better visibility
        
        canvasCtx.fillStyle = gradient;
        canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
        
        x += barWidth + 1;
      }
      
      visualizerAnimationId = requestAnimationFrame(drawVisualizer);
    }
    
    function toggleVisualizer() {
      visualizerActive = !visualizerActive;
      
      if (visualizerActive) {
        setupVisualizer();
        if (currentAudio) {
          if (audioCtx.state === 'suspended') audioCtx.resume();
          connectVisualizer(currentAudio);
        }
        drawVisualizer();
        visualizerToggle.classList.add('active');
      } else {
        if (visualizerAnimationId) {
          cancelAnimationFrame(visualizerAnimationId);
          visualizerAnimationId = null;
        }
        canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        visualizerToggle.classList.remove('active');
      }
      
      // Save preference
      localStorage.setItem('visualizerActive', visualizerActive ? 'true' : 'false');
    }
    
    visualizerToggle.addEventListener('click', toggleVisualizer);
    
    function loadVisualizer() {
      const savedPreference = localStorage.getItem('visualizerActive');
      if (savedPreference === 'true') {
        toggleVisualizer();
      }
    }
    
    function initializeMusicPlayer() {
      musicGrid.innerHTML = '';
      
      // Load saved playback mode
      const savedMode = localStorage.getItem('playbackMode');
      playbackModes.current = savedMode || 'none';
      updateModeIndicators();
      
      // Get song list
      scanForMusicFiles().then(availableFiles => {
        tracks = availableFiles;
        
        // Create music cards
        allMusicCards = tracks.map((song, index) => {
          const card = createMusicCard(song, index);
          musicGrid.appendChild(card);
          return card;
        });
      });
    }
    
    // Get song list function
    function scanForMusicFiles() {
      const songList = [{
        "title": "Analfried Song",
        "thumbnail": "https://i.imgur.com/rU8nXfL.png",
        "path": "https://serverbase.laveimma.workers.dev/analfried%20song.mp3"
      },
      {
        "title": "Alpha Lehrer",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Alpha Lehrer.png",
        "path": "https://serverbase.laveimma.workers.dev/Alpha Lehrer.mp3"
      },
      {
        "title": "Ave Natale",
        "thumbnail": "https://i.imgur.com/vnL2rRQ.png",
        "path": "https://serverbase.laveimma.workers.dev/Ave Natale.mp3"
      },
      {
        "title": "Abschaumkanidaten",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Abschaumkandidaten.png",
        "path": "https://serverbase.laveimma.workers.dev/Abschaumkandidaten.m4a"
      },
      {
        "title": "Besgen im Haus",
        "thumbnail": "https://i.imgur.com/LGY7Ugh.png",
        "path": "https://serverbase.laveimma.workers.dev/Besgen_im_Haus.mp3"
      },
      {
        "title": "Beste im Biz",
        "thumbnail": "https://i.imgur.com/eRufmDB.png",
        "path": "https://serverbase.laveimma.workers.dev/Beste_im_Biz.mp3"
      },
      {
        "title": "Clyde gegen Rüdiger und Niko",
        "thumbnail": "https://i.imgur.com/zaQVCSY.png",
        "path": "https://serverbase.laveimma.workers.dev/Clyde_gegen_R_diger_und_Niko.mp3"
      },
      {
        "title": "Der Größte und Tollste",
        "thumbnail": "https://i.imgur.com/G3MRTe1.png",
        "path": "https://serverbase.laveimma.workers.dev/größte und tollste.m4a"
      },
      {
        "title": "Ich bin der Titan",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Ich bin der Titan.png",
        "path": "https://serverbase.laveimma.workers.dev/Titan.mp3"
      },
      {
        "title": "Deutschland GmbH",
        "thumbnail": "https://i.imgur.com/JEGB6yf.png",
        "path": "https://serverbase.laveimma.workers.dev/Deutschland_GmbH.mp3"
      },
      {
        "title": "Die Schule ist ein Witz",
        "thumbnail": "https://i.imgur.com/A98pl0L.png",
        "path": "https://serverbase.laveimma.workers.dev/Die_Schule_ist_ein_Witz.mp3"
      },
      {
        "title": "Disstrack gegen Berrewitz",
        "thumbnail": "https://i.imgur.com/HOJbtsF.png",
        "path": "https://serverbase.laveimma.workers.dev/Disstrack_gegen_Berrewitz.mp3"
      },
      {
        "title": "Disstrack gegen Besgen",
        "thumbnail": "https://i.imgur.com/0lgqrve.png",
        "path": "https://serverbase.laveimma.workers.dev/Disstrack gegen Besgen.mp3"
      },
      {
        "title": "Dual Shadows",
        "thumbnail": "https://i.imgur.com/MVqqDkZ.png",
        "path": "https://serverbase.laveimma.workers.dev/Dual_Shadows.mp3"
      },
      {
        "title": "Eclipsed Horizions",
        "thumbnail": "https://i.imgur.com/IIqcUAP.png",
        "path": "https://serverbase.laveimma.workers.dev/Eclipsed_Horizions.mp3"
      },
      {
        "title": "Fick die Schule",
        "thumbnail": "https://i.imgur.com/AvyljGe.png",
        "path": "https://serverbase.laveimma.workers.dev/Fick_die_Schule.mp3"
      },
      {
        "title": "Fisch an Land",
        "thumbnail": "https://i.imgur.com/VyblhJC.png",
        "path": "https://serverbase.laveimma.workers.dev/Fisch_an_Land.mp3"
      },
      {
        "title": "Granny Rap - In den alten Jahren",
        "thumbnail": "https://i.imgur.com/qGC2chy.png",
        "path": "https://serverbase.laveimma.workers.dev/Granny_Rap___In_den_alten_Jahren.mp3"
      },
      {
        "title": "Große Namen große Worte",
        "thumbnail": "https://cdn2.suno.ai/cbe38b4f-45bc-46b6-89d2-f295497b98a5_e6de5789.jpeg",
        "path": "https://serverbase.laveimma.workers.dev/Große Namen%2C große Worte.mp3"
      },
      {
        "title": "Hattig's Schäferhund",
        "thumbnail": "https://i.imgur.com/i3D57cb.png",
        "path": "https://serverbase.laveimma.workers.dev/Hattig_s_Sch_ferhund.mp3"
      },
      {
        "title": "Inferno",
        "thumbnail": "https://i.imgur.com/0ONzAdK.png",
        "path": "https://serverbase.laveimma.workers.dev/Inferno.mp3"
      },
      {
        "title": "Jüdisch ist normal",
        "thumbnail": "https://i.imgur.com/phhCDUv.png",
        "path": "https://serverbase.laveimma.workers.dev/J_disch_ist_normal.mp3"
      },
      {
        "title": "Jüdisch ist normal 2",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Jüdisch ist normal 2.png",
        "path": "https://serverbase.laveimma.workers.dev/Jüdisch ist normal 2.mp3"
      },
      {
        "title": "Kein Limit",
        "thumbnail": "https://cdn2.suno.ai/8cb3993b-df74-4171-80a6-cbee2eae2d0e_c9c50a12.jpeg",
        "path": "https://cdn1.suno.ai/8cb3993b-df74-4171-80a6-cbee2eae2d0e.mp3"
      },
      {
        "title": "Kein Platz für Schwächlinge",
        "thumbnail": "https://i.imgur.com/xpAQcEB.png",
        "path": "https://serverbase.laveimma.workers.dev/Kein_Platz_f_r_Schw_chlinge.mp3"
      },
      {
        "title": "Last View",
        "thumbnail": "https://i.imgur.com/oo5HheM.png",
        "path": "https://serverbase.laveimma.workers.dev/Last_View.mp3"
      },
      {
        "title": "Mamadou Song",
        "thumbnail": "https://cdn.discordapp.com/avatars/1278460402719657984/95ebbb1971361670a93f10d0fe49b246.png?size=1024&width=940&height=940",
        "path": "https://serverbase.laveimma.workers.dev/Mamadou Song.mp3"
      },
      {
        "title": "Whispers of a broken heart",
        "thumbnail": "https://i.imgur.com/PYkgDtl.png",
        "path": "https://serverbase.laveimma.workers.dev/Whispers_of_a_broken_heart.mp3"
      },
      {
        "title": "Rüdiger Song",
        "thumbnail": "https://i.imgur.com/jth0slY.png",
        "path": "https://serverbase.laveimma.workers.dev/R_diger_Song.mp3"
      },
      {
        "title": "Niko durch die Gänge",
        "thumbnail": "https://cdn.discordapp.com/avatars/1278455593044148254/a_4e8372b72b160d18c49b0f4bc897e49e.gif?size=4096",
        "path": "https://serverbase.laveimma.workers.dev/Niko%20durch%20die%20g%C3%A4nge.mp3"
      },
      {
        "title": "Die drei Kriegsverbrecher",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Die%20drei%20Kriegsverbrecher.png",
        "path": "https://serverbase.laveimma.workers.dev/Die%20drei%20Kriegsverbrecher.mp3"
      },
      {
        "title": "Rise Above",
        "thumbnail": "https://i.imgur.com/TR7N0j2.png",
        "path": "https://serverbase.laveimma.workers.dev/Rise_Above.mp3"
      },
      {
        "title": "Rise from the Ruins",
        "thumbnail": "https://i.imgur.com/CbbUryc.png",
        "path": "https://serverbase.laveimma.workers.dev/Rise_from_the_Ruins.mp3"
      },
      {
        "title": "Seck am Start",
        "thumbnail": "https://i.imgur.com/9E90qRs.png",
        "path": "https://serverbase.laveimma.workers.dev/Seck_am_Start.mp3"
      },
      {
        "title": "Mamadou Seck: Die Eisenfaust der Disziplin",
        "thumbnail": "https://i.imgur.com/tqwMXQZ.png",
        "path": "https://cdn1.suno.ai/1bf2ab44-552b-4901-9826-42528932b39f.wav"
      },
      {
        "title": "Niko du Witzfigur",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Witzfigur.png",
        "path": "https://serverbase.laveimma.workers.dev/Witzfigur.mp3"
      },
      {
        "title": "Soundclash Remix",
        "thumbnail": "https://i.imgur.com/nVK3uhP.png",
        "path": "https://serverbase.laveimma.workers.dev/Soundclash_Remix.mp3"
      },
      {
        "title": "Ihr Abschaum",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Ihr%20Abschaum.png",
        "path": "https://serverbase.laveimma.workers.dev/Ihr%20Abschaum.mp3"
      },
      {
        "title": "Born in the Fire",
        "thumbnail": "https://cdn2.suno.ai/image_large_32bcd2ed-b7cd-41b0-827c-8b8dba0e2465.jpeg",
        "path": "https://serverbase.laveimma.workers.dev/Born in the Fire.mp3"
      },
      {
        "title": "Adi gegen Niko",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Adi%20gegen%20Niko.png",
        "path": "https://serverbase.laveimma.workers.dev/Adi%20gegen%20Niko.mp3"
      },
      {
        "title": "Alles Mist",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Alles%20Mist.png",
        "path": "https://serverbase.laveimma.workers.dev/Alles%20Mist.mp3"
      },
      {
        "title": "Das Winni Schwein",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Das%20Winni%20Schwein.png",
        "path": "https://serverbase.laveimma.workers.dev/Das%20Winni%20Schwein.mp3"
      },
      {
        "title": "Du Wicht",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Du%20Wicht.png",
        "path": "https://serverbase.laveimma.workers.dev/HeyStan%20du%20wicht.mp3"
      },
      {
        "title": "Monster in der Hose",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Monster%20in%20der%20Hose.png",
        "path": "https://serverbase.laveimma.workers.dev/Monster%20in%20der%20Hose.mp3"
      },
      {
        "title": "Ich bin ein Soziopath",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Mimon.jpg",
        "path": "https://serverbase.laveimma.workers.dev/Ich%20bin%20ein%20Soziopath.mp3"
      },
      {
        "title": "RB, Verpiss dich!",
        "thumbnail": "https://serverbase.laveimma.workers.dev/RB%20Verpiss%20dich.png",
        "path": "https://serverbase.laveimma.workers.dev/RB%20Piss%20Dich.mp3"
      },
      {
        "title": "Maximal Disziplin",
        "thumbnail": "https://cdn2.suno.ai/41bbce05-de29-40b3-96c0-c3d365de1286_d1866cad.jpeg",
        "path": "https://cdn1.suno.ai/41bbce05-de29-40b3-96c0-c3d365de1286.mp3"
      },
      {
        "title": "Analfried Frisst Niko",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Analfried%20frisst%20Niko.png",
        "path": "https://serverbase.laveimma.workers.dev/Analfried%20frisst%20Niko.mp3"
      },
      {
        "title": "Wannabe Legends",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Wannabe%20Legends.webp",
        "path": "https://serverbase.laveimma.workers.dev/Wannabe_Legends.mp3"
      },
      {
        "title": "Schmitzgame Song",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Schmitzgame%20Song.png",
        "path": "https://serverbase.laveimma.workers.dev/Fixed_Schmitzgame.mp3"
      },
      {
        "title": "Oh Clyde",
        "thumbnail": "https://serverbase.laveimma.workers.dev/Oh%20Clyde.png",
        "path": "https://serverbase.laveimma.workers.dev/Oh%20Clyde.mp3"
      }];
      
      // Sort alphabetically
      songList.sort((a, b) => a.title.localeCompare(b.title, 'de'));
      
      return Promise.resolve(songList);
    }
    
    // Media Session API
    if ('mediaSession' in navigator) {
      navigator.mediaSession.setActionHandler('nexttrack', playNextTrack);
      navigator.mediaSession.setActionHandler('previoustrack', playPrevTrack);
      navigator.mediaSession.setActionHandler('play', () => {
        if (currentAudio && currentAudio.paused) {
          playPauseControl.click();
        }
      });
      navigator.mediaSession.setActionHandler('pause', () => {
        if (currentAudio && !currentAudio.paused) {
          playPauseControl.click();
        }
      });
    }
    
    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
      initializeMusicPlayer();
      initializeVolume();
      loadVisualizer();
    });
  </script>
</body>
</html>
